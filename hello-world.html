<!DOCTYPE html>
<html lang="en-us">

	<head>
			
		<meta charset="utf-8">
		<title>Area Selection</title>

		<script src="//code.jquery.com/jquery.min.js"></script>
		
	</head>

	<body>
		
		<input type="button" id="enableSelectionButton" value="SELECT" onclick="enableAreaSelection('enableSelectionButton')">
		<input type="button" id="enableMovementButton" value="MOVE" onclick="enableAreaMovement('enableMovementButton')">
		<div class="AreaSelection"></div>
		<script>
			var imgID = 1;
			$('.AreaSelection').append("<div hidden id='selection' style='background-color:#dddddd; position:absolute'></div><img hidden id='imgReady"+imgID+"' style='position:absolute;border-radius:10px' src='DefaultImage.jpg' ondragenter='onDragEnter(event)' ondragover='onDragOver(event)' ondrop='onDrop(event)' onmousedown='setCurrentElement(this)' ondragstart='return false'/>");
  		
			function onDragEnter(event) {
      	//if (event.dataTransfer.dropEffect == "move")
        event.preventDefault();
		  }
		  
		  function onDragOver(event) {
		    //if (event.dataTransfer.dropEffect == "move")
		    event.preventDefault();
		  }
			// onDrop start
			function onDrop(event) {                                
		    var file = event.dataTransfer.files[0];      

		    var dropSpot = event.target;
		    
		    var imageType = /image.*/;
		    var textType = /text.*/;
		    var isImage = false;
		    var isText = false;
		    if(file.type.match(imageType)){
		      isImage = true; 
		    }
		    else if(file.type.match(textType)){
		      isText = true;
		    } 
		             
		    var reader = new FileReader();    
		    
		    reader.onload = (function(aFile) {
		      return function(e) {         
		        var result = e.target.result;  
		        if(isImage) {
		          dropSpot.src = result;
		          dropSpot.ondragstart="return false";
		        } else if(isText) {
		        	 //dropSpot.src = null;
		           //dropSpot.innerHTML = result;
		           //dropSpot.style.display = 'block';
		           //dropSpot.style.overflow = 'hidden';
		           window.alert('You dragged a text file!');
		        } else {
		        	window.alert('Only allows image or text file.');
		        }
		      };
		    })(file);
		      
		    if(isImage) { reader.readAsDataURL(file); }
		    else { reader.readAsText(file,"EUC-KR"); }
			    event.stopPropagation();
			    event.preventDefault();
	    }                      
  		// onDrop end
  		//dropImage.addEventListener("load", function(e) { }, true);
			//
			var selectionEnabled = false; //flag value
    	var movementEnabled = false;
    	var isDragging = false; //check if the user is dragging something
    	
	    function enableAreaSelection(buttonID) {
	    	if(!movementEnabled) {
		      selectionEnabled = selectionEnabled ? false : true; //toggle flag
		      //activate the button (toggling)
	    	}
	    }
	    function enableAreaMovement(buttonID) {
	    	if(!selectionEnabled) {
	    		movementEnabled = movementEnabled ? false : true; //toggle flag
	    		//activate the button (toggling)
	    		window.alert("movementEnabled: "+movementEnabled);
	    	}
	    }
	    
			var box = document.getElementById('selection'),
			x1 = 0, y1 = 0, x2 = 0, y2 = 0,
			boxWidth = 0, boxHeight = 0,
			initXdiff = 0, initYdiff = 0;
			var currentElement = null;
			
			function setCurrentElement(element) {
				
				if(!isDragging && movementEnabled) {
					if(element != null);
					else window.alert('current is null');
				  currentElement = element;
					
					//x1 = 0;
					//y1 = 0; //이부분을 마우스 포인터의 위치로 바꾸자
				}
			}
			
	    function setBox() { //Resize the box
        var x3 = Math.min(x1,x2);
        var x4 = Math.max(x1,x2);
        var y3 = Math.min(y1,y2);
        var y4 = Math.max(y1,y2);
        box.style.left = x3 + 'px';
        box.style.top = y3 + 'px';
        boxWidth = x4 - x3;
        boxHeight = y4 - y3;
        box.style.width = boxWidth + 'px';
        box.style.height = boxHeight + 'px';
	    }
    	
    	function moveArea() { //Move the selected area
    		//var x3 = x2 - x1; //difference (delta x)
    		//var y3 = y2 - y1; //difference (delta y)
    		
    		//window.alert("startpoint: " + x1 +"," +y1 +"\nnewpoint: "+x2 +"," +y2);
    		//var leftValue = currentElement.style.left.replace('px','');
    		var leftValue = parseInt(currentElement.style.left);
    		var topValue = parseInt(currentElement.style.top);

    		currentElement.style.left = x2 - initXdiff + 'px';
    		currentElement.style.top = y2 - initYdiff + 'px';
    		
    		//initial point로 x3와 y3를 설정하자
    	}
    	
    	function setInitDiff() {
    		initXdiff = x1 - parseInt(currentElement.style.left);
    		initYdiff = parseInt(currentElement.style.top) - y1;
    	}
      onmousedown = function(e) {
      	isDragging = true; //hold
      	if(selectionEnabled) {
	        box.hidden = 0;
	        x1 = e.clientX;
	        y1 = e.clientY;
	        setBox();
	        
      	} else if(movementEnabled) {
      		x1 = e.clientX;
      		y1 = e.clientY;
      		setInitDiff();
      		moveArea();
      	}
      };
      onmousemove = function(e) {
      	if(selectionEnabled) {
	        x2 = e.clientX;
	        y2 = e.clientY;
	        setBox();
      	} else if(movementEnabled && isDragging) {
      		
      		x2 = e.clientX;
      		y2 = e.clientY;
      		moveArea();
      	}
      };
      onmouseup = function(e) {
      	
      	isDragging = false; //release
      	
      	//window.alert('mouseup!');
        if(selectionEnabled) {
        	box.hidden = 1;
        	
        	if(boxWidth > 30 && boxHeight > 30) {
	        	var img_area = document.getElementById("imgReady"+imgID);
	        	img_area.style.left = box.style.left;
	        	img_area.style.top = box.style.top;
	        	img_area.style.width = box.style.width;
	        	img_area.style.height = box.style.height;
	        	img_area.hidden = 0;
	        	selectionEnabled = false;
	        	imgID++;
	        	$('.AreaSelection').append("<img hidden id='imgReady"+imgID+"' style='position:absolute;border-radius:10px' src='DefaultImage.jpg' ondragenter='onDragEnter(event)' ondragover='onDragOver(event)' ondrop='onDrop(event)' onmousedown='setCurrentElement(this)' ondragstart='return false'/>"); // Create a new empty image
        	}
        } else if(movementEnabled) {
        	currentElement = null;
        }
      };
    
		</script>
	</body>

</html>
